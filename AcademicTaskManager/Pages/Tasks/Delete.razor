@page "/tasks/delete/{id:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using AcademicTaskManager.Data
@using AcademicTaskManager.Models
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<h3>Eliminar Tarea</h3>

@if (task == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <div class="alert alert-danger">
        ¿Estás seguro de que deseas eliminar la tarea <b>@task.Title</b>?
    </div>
    <button class="btn btn-danger" @onclick="DeleteTask">Eliminar</button>
    <a class="btn btn-secondary ms-2" href="/tasks">Cancelar</a>
}

@code {
    [Parameter] public int id { get; set; }
    private TaskItem task = new();

    protected override async Task OnInitializedAsync()
    {
        var foundTask = await Db.TaskItems.FindAsync(id);
        task = foundTask ?? new TaskItem();
    }

    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    private async Task DeleteTask()
    {
        try
        {
            Db.TaskItems.Remove(task);
            await Db.SaveChangesAsync();
            successMessage = "Task deleted successfully";
            await Task.Delay(1200);
            Nav.NavigateTo("/tasks");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}