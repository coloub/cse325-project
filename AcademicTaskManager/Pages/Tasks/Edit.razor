@page "/tasks/edit/{id:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using AcademicTaskManager.Data
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using AcademicTaskManager.Models
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<h3>Editar Tarea</h3>

@if (task == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <EditForm Model="task" OnValidSubmit="UpdateTask">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label>Título</label>
            <InputText class="form-control" @bind-value="task.Title" />
        </div>
        <div class="mb-3">
            <label>Descripción</label>
            <InputTextArea class="form-control" @bind-value="task.Description" />
        </div>
        <div class="mb-3">
            <label>Fecha Límite</label>
            <InputDate class="form-control" @bind-value="task.DueDate" />
        </div>
        <div class="mb-3">
            <label>Proyecto</label>
            <InputSelect class="form-select" @bind-value="task.ProjectId">
                @foreach (var p in projects)
                {
                    <option value="@p.Id">@p.Name</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label>Estado</label>
            <InputSelect class="form-select" @bind-value="task.Status">
                @foreach (AcademicTaskManager.Models.TaskStatus status in Enum.GetValues(typeof(AcademicTaskManager.Models.TaskStatus)))
                {
                    <option value="@status">@status</option>
                }
            </InputSelect>
        </div>
        <button class="btn btn-primary" type="submit">Guardar</button>
        <a class="btn btn-secondary ms-2" href="/tasks">Cancelar</a>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }
    private TaskItem task = new();
    private List<Project> projects = new();
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var foundTask = await Db.TaskItems.FindAsync(id);
        task = foundTask ?? new TaskItem();
        projects = await Db.Projects.ToListAsync();
    }

    private async Task UpdateTask()
    {
        try
        {
            Db.TaskItems.Update(task);
            await Db.SaveChangesAsync();
            successMessage = "Task updated successfully";
            await Task.Delay(1200);
            Nav.NavigateTo("/tasks");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}